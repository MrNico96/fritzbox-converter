<!DOCTYPE html>
<html lang="de">
<head>
<meta http-equiv=content-type content="text/html; charset=utf-8" />
</head>
<body>
<h1>Fritzbox Contact convert</h1>
<br>Very primitiv: just the name+number (other data are lost); works offline
<a href="https://github.com/soerenj/fb_convert_conects_xml_csv/new/master" style="float:right">fork me</a>
<span style="clear:both"></span><br>
<hr>
<br>
Fritzbox XML File:<br>
<input type="file" id="file-input_xml"  /><br>
<span style="color:#999999">source:</span><br>
<textarea id="adressbuch_xml"  style="width:80%;height:100pt;color:#999999">
<?xml version="1.0" encoding="utf-8"?>
<phonebooks>
<phonebook owner="" name="phonebook1">
<contact>
<category>0</category>
<person><realName>Person A</realName></person>
<telephony nid="1"><number type="mobile" prio="1" id="0">017611111</number></telephony>
<services /><setup />
<features doorphone="0" /><mod_time>1535972380</mod_time><uniqueid>227</uniqueid>
</contact>
<contact>
<category>0</category>
<person><realName>Person B</realName></person>
<telephony nid="1"><number type="mobile" prio="1" id="0">0176222222</number></telephony>
<services /><setup />
<features doorphone="0" /><mod_time>1535972450</mod_time><uniqueid>229</uniqueid>
</contact>
</phonebook>
</phonebooks>
</textarea>


<br><br>
<!-- ↓↑ ⇓⇑ ⇩⇧ ⟱ ⟰ ⬆⬇ -->
<input type="button" value="⬇ Convert to csv" onClick="convert_to_csv()"/>  &nbsp; <input type="button" value="⬆ Convert to xml" onClick="convert_to_xml()"/>   &nbsp;  <input type="button" value="✖ Reset" title="reset to default" onClick="reset_to_default()"/>

<br>
<br>
CSV File:<br>
<input type="file" id="file-input_csv"  /><br>
<span style="color:#999999">source:</span><br>
<textarea id="adressbuch_csv" style="width:80%;height:100pt;color:#999999">
"Person C", "080333333"
"Person D", "080444444"
</textarea>
</div>

<script language="JavaScript">
<!--
function reset_to_default(){
 document.getElementById('adressbuch_xml').value = document.getElementById('adressbuch_xml').defaultValue;
 document.getElementById('adressbuch_csv').value = document.getElementById('adressbuch_csv').defaultValue;
}
function convert_to_csv(){
 var text = document.getElementById('adressbuch_xml').value;
 parser = new DOMParser();
 xmlDoc = parser.parseFromString(text, "text/xml");

 var out, contacts, contact, person, telephony, telefone_numbers, telefone_numbers_type, telefone_numbers_prio, phone;
 out = '';
 var contacts = xmlDoc.getElementsByTagName("contact");
 for(i=0;i<contacts.length;i++)
 {
  contact = contacts[i];
  person = contact.getElementsByTagName("person")[0].getElementsByTagName("realName")[0].firstChild.nodeValue;
  telephony = contact.getElementsByTagName("telephony")[0].getElementsByTagName("number");
  //telefone_numbers = Array(); telefone_numbers_type = Array(); telefone_numbers_prio = Array();
  out += '"'+person.replace('"','\\"')+'"';
  for(j=0;j<telephony.length;j++){
   //telefone_numbers.push (  telephony[i].firstChild.nodeValue );
   //telefone_numbers_type.push (  telephony[i].getAttribute('type') );
   //telefone_numbers_prio.push (  telephony[i].getAttribute('prio') );
   phone = telephony[j].firstChild.nodeValue;
   out += ", "+ '"'+phone.replace('"','\\"')+'"';;
  }
  out += "\n";
 }
 document.getElementById('adressbuch_csv').value = out;

}

function convert_to_xml(){
 var text = document.getElementById('adressbuch_csv').value;
 var out = '';
 out += '<?xml version="1.0" encoding="utf-8"?>\n<phonebooks>\n<phonebook owner="" name="convertedFromXml">\n';
 var contacts = CSVToArray(text);
 for(i=0;i<contacts.length;i++)
 {
  if(contacts[i]=='')continue;
  out += '<contact>\n<category>0</category>\n';
  var elements = contacts[i];
  out += '<person><realName>'+elements[0].substring(1)+'</realName></person>\n';
  out += '<telephony nid="'+i+'">\n';
  for(j=1;j<elements.length;j++){
   var phone = elements[j];
   if(j==elements.length-1)phone = phone.substring(0,phone.length-1);
   phone = phone.replace(/^\s+|\s+$/gm,''); //trim spaces
   phone = phone.replace(/^"+|"+$/gm,''); //trim "
   out += '<number>'+phone+'</number>\n';
  }
  out += '</telephony>\n<services /><setup />\n<features doorphone="0" /><mod_time></mod_time><uniqueid></uniqueid>\n</contact>\n';
 }
 out += '</phonebook>\n</phonebooks>';
 document.getElementById('adressbuch_xml').value = out;

}


    // ref: http://stackoverflow.com/a/1293163/2343
    // This will parse a delimited string into an array of
    // arrays. The default delimiter is the comma, but this
    // can be overriden in the second argument.
    function CSVToArray( strData, strDelimiter ){
        // Check to see if the delimiter is defined. If not,
        // then default to comma.
        strDelimiter = (strDelimiter || ",");

        // Create a regular expression to parse the CSV values.
        var objPattern = new RegExp(
            (
                // Delimiters.
                "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +

                // Quoted fields.
                "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +

                // Standard fields.
                "([^\\" + strDelimiter + "\\r\\n]*))"
            ),
            "gi"
            );


        // Create an array to hold our data. Give the array
        // a default empty first row.
        var arrData = [[]];

        // Create an array to hold our individual pattern
        // matching groups.
        var arrMatches = null;


        // Keep looping over the regular expression matches
        // until we can no longer find a match.
        while (arrMatches = objPattern.exec( strData )){

            // Get the delimiter that was found.
            var strMatchedDelimiter = arrMatches[ 1 ];

            // Check to see if the given delimiter has a length
            // (is not the start of string) and if it matches
            // field delimiter. If id does not, then we know
            // that this delimiter is a row delimiter.
            if (
                strMatchedDelimiter.length &&
                strMatchedDelimiter !== strDelimiter
                ){

                // Since we have reached a new row of data,
                // add an empty row to our data array.
                arrData.push( [] );

            }

            var strMatchedValue;

            // Now that we have our delimiter out of the way,
            // let's check to see which kind of value we
            // captured (quoted or unquoted).
            if (arrMatches[ 2 ]){

                // We found a quoted value. When we capture
                // this value, unescape any double quotes.
                strMatchedValue = arrMatches[ 2 ].replace(
                    new RegExp( "\"\"", "g" ),
                    "\""
                    );

            } else {

                // We found a non-quoted value.
                strMatchedValue = arrMatches[ 3 ];

            }


            // Now that we have our value string, let's add
            // it to the data array.
            arrData[ arrData.length - 1 ].push( strMatchedValue );
        }

        // Return the parsed data.
        return( arrData );
    }



function readSingleFile(e) {
  var file = e.target.files[0];
  if (!file) {
    return;
  }
  var reader = new FileReader();
  if(e.target.id=='file-input_xml'){
    reader.onload = function(e) {
      var contents = e.target.result;
      document.getElementById('adressbuch_xml').value = contents;
    };
  }
  if(e.target.id=='file-input_csv'){
    reader.onload = function(e) {
      var contents = e.target.result;
      document.getElementById('adressbuch_csv').value = contents;
    };
  }
  reader.readAsText(file);
}


document.getElementById('file-input_xml')
  .addEventListener('change', readSingleFile, false);
document.getElementById('file-input_csv')
  .addEventListener('change', readSingleFile, false);

//-->
</script>
