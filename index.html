<!DOCTYPE html>
<html>
<head>
<meta http-equiv=content-type content="text/html; charset=utf-8" />
<style> input{ cursor: pointer } .advanced_view{ display:none; }</style>
</head>
<body>

<h1 lang="en" class="en">Phonebook Contact convert for Fritzbox</h1>
<h1 lang="de" class="de" style="display:none">Telefonbuch Kontakte konvertieren für Fritzbox</h1>
<p lang="en" class="en">Converts XML-File or CSV-File with Phone Numbers to/from Fritzbox.</p>
<p lang="de" class="de" style="display:none">Konvertiert XML-Dateien oder CSV-Dateien mit Telefonnummer von/zur Fritzbox</p>
<span style="clear:both"></span><br>
<hr>
<br>
Fritzbox XML File:<br>
<input type="file" id="file-input_xml"  /><br>
<span style="color:#999999" class="advanced_view">source:</span><br>
<textarea id="adressbuch_xml"  style="width:80%;height:100pt;color:#999999" class="advanced_view">
<?xml version="1.0" encoding="utf-8"?>
<phonebooks>
<phonebook owner="" name="phonebook1">
<contact>
<category>0</category>
<person><realName>Person A</realName></person>
<telephony nid="1"><number type="mobile" prio="1" id="0">017611111</number></telephony>
<services /><setup />
<features doorphone="0" /><mod_time>1535972380</mod_time><uniqueid>227</uniqueid>
</contact>
<contact>
<category>0</category>
<person><realName>Person B</realName></person>
<telephony nid="1"><number type="mobile" prio="1" id="0">0176222222</number></telephony>
<services /><setup />
<features doorphone="0" /><mod_time>1535972450</mod_time><uniqueid>229</uniqueid>
</contact>
</phonebook>
</phonebooks>
</textarea>

<p align="center" id="show_advanced_view_link_wrapper" >
<span lang="en" class="en">or, use</span>
<span lang="de" class="de" style="display:none">oder, </span>
<a href="#" onclick="show_advanced_view();return false">
<span lang="en" class="en">advanded mode</span><span lang="de" class="de" style="display:none;text-decoration:underline;">erweiterten Modus</span></a>
<span lang="de" class="de" style="display:none"> benutzen </span>
</p>

<!-- ↓↑ ⇓⇑ ⇩⇧ ⟱ ⟰ ⬆⬇ -->
<br>
<div class="advanced_view">
<input type="button" value="⬇ Convert to csv" onClick="convert_to_csv()"/>  &nbsp; <input type="button" value="⬆ Convert to xml" onClick="convert_to_xml()"/>   &nbsp;  <input type="button" value="✖ Reset to Test-Values" title="reset to default" onClick="reset_to_default()"/>
</div>
<br><br>
CSV File:<br>
<input type="file" id="file-input_csv"  /><br>
<span style="color:#999999" class="advanced_view">source:</span><br>
<textarea id="adressbuch_csv" style="width:80%;height:100pt;color:#999999" class="advanced_view">
"Person C", "080333333"
"Person D", "080444444"
</textarea>
</div>

<script language="JavaScript">
<!--
var uploaded_xml_filename = '';
var uploaded_csv_filename = '';

function reset_to_default(){
 document.getElementById('adressbuch_xml').value = document.getElementById('adressbuch_xml').defaultValue;
 document.getElementById('adressbuch_csv').value = document.getElementById('adressbuch_csv').defaultValue;
}


function convert_to_csv(){
 var text = document.getElementById('adressbuch_xml').value;
 parser = new DOMParser();
 xmlDoc = parser.parseFromString(text, "text/xml");

 var out, contacts, contact, person, telephony, telefone_numbers, telefone_numbers_type, telefone_numbers_prio, phone;
 out = '';
 var contacts = xmlDoc.getElementsByTagName("contact");
 for(i=0;i<contacts.length;i++)
 {
  contact = contacts[i];
  person = contact.getElementsByTagName("person")[0].getElementsByTagName("realName")[0].firstChild.nodeValue;
  telephony = contact.getElementsByTagName("telephony")[0].getElementsByTagName("number");
  //telefone_numbers = Array(); telefone_numbers_type = Array(); telefone_numbers_prio = Array();
  out += '"'+person.replace('"','\\"')+'"';
  for(j=0;j<telephony.length;j++){
   //telefone_numbers.push (  telephony[i].firstChild.nodeValue );
   //telefone_numbers_type.push (  telephony[i].getAttribute('type') );
   //telefone_numbers_prio.push (  telephony[i].getAttribute('prio') );
   phone = telephony[j].firstChild.nodeValue;
   out += ", "+ '"'+phone.replace('"','\\"')+'"';;
  }
  out += "\n";
 }
 document.getElementById('adressbuch_csv').value = out;
 
 download('csv',out);
}


function convert_to_xml(){
 var text = document.getElementById('adressbuch_csv').value;
 var out = '';
 out += '<?xml version="1.0" encoding="utf-8"?>\n<phonebooks>\n<phonebook owner="" name="convertedFromXml">\n';
 var contacts = CSVToArray(text);
 for(i=0;i<contacts.length;i++)
 {
  if(contacts[i]=='')continue;
  out += '<contact>\n<category>0</category>\n';
  var elements = contacts[i];
  out += '<person><realName>'+elements[0].substring(1)+'</realName></person>\n';
  out += '<telephony nid="'+i+'">\n';
  for(j=1;j<elements.length;j++){
   var phone = elements[j];
   if(j==elements.length-1)phone = phone.substring(0,phone.length-1);
   phone = phone.replace(/^\s+|\s+$/gm,''); //trim spaces
   phone = phone.replace(/^"+|"+$/gm,''); //trim "
   out += '<number>'+phone+'</number>\n';
  }
  out += '</telephony>\n<services /><setup />\n<features doorphone="0" /><mod_time></mod_time><uniqueid></uniqueid>\n</contact>\n';
 }
 out += '</phonebook>\n</phonebooks>';
 document.getElementById('adressbuch_xml').value = out;

 download('xml',out);
}


function download(filename, text) {

  if(filename=='xml'){
   var filename = 'adressbuch_for_fritzbox_xml.xml';
   if(uploaded_csv_filename!=''){
    var lin = uploaded_csv_filename.split('\\');
    var win = uploaded_csv_filename.split('/');
    if(lin.length>win.length) filename = lin[lin.length-1];
    else filename = win[lin.length-1];
    filename += "_converted_primitv.xml";
   }
  }
  if(filename=='csv'){
   var filename = 'adressbuch_from_fritzbox.csv';
   if(uploaded_xml_filename!=''){ console.log(uploaded_xml_filename);
    var lin = uploaded_xml_filename.split('\\');
    var win = uploaded_xml_filename.split('/');
    if(lin.length>win.length) filename = lin[lin.length-1];
    else filename = win[lin.length-1];
    filename += "_converted_primitv.csv";
   }
  }

  var element = document.createElement('a');
  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  element.setAttribute('download', filename);

  element.style.display = 'none';
  document.body.appendChild(element);

  element.click();

  document.body.removeChild(element);
}

// ref: http://stackoverflow.com/a/1293163/2343
// This will parse a delimited string into an array of
// arrays. The default delimiter is the comma, but this
// can be overriden in the second argument.
function CSVToArray( strData, strDelimiter ){
    // Check to see if the delimiter is defined. If not,
    // then default to comma.
    strDelimiter = (strDelimiter || ",");

    // Create a regular expression to parse the CSV values.
    var objPattern = new RegExp(
        (
            // Delimiters.
            "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +

            // Quoted fields.
            "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +

            // Standard fields.
            "([^\\" + strDelimiter + "\\r\\n]*))"
        ),
        "gi"
        );


    // Create an array to hold our data. Give the array
    // a default empty first row.
    var arrData = [[]];

    // Create an array to hold our individual pattern
    // matching groups.
    var arrMatches = null;


    // Keep looping over the regular expression matches
    // until we can no longer find a match.
    while (arrMatches = objPattern.exec( strData )){

        // Get the delimiter that was found.
        var strMatchedDelimiter = arrMatches[ 1 ];

        // Check to see if the given delimiter has a length
        // (is not the start of string) and if it matches
        // field delimiter. If id does not, then we know
        // that this delimiter is a row delimiter.
        if (
            strMatchedDelimiter.length &&
            strMatchedDelimiter !== strDelimiter
            ){

            // Since we have reached a new row of data,
            // add an empty row to our data array.
            arrData.push( [] );

        }

        var strMatchedValue;

        // Now that we have our delimiter out of the way,
        // let's check to see which kind of value we
        // captured (quoted or unquoted).
        if (arrMatches[ 2 ]){

            // We found a quoted value. When we capture
            // this value, unescape any double quotes.
            strMatchedValue = arrMatches[ 2 ].replace(
                new RegExp( "\"\"", "g" ),
                "\""
                );

        } else {

            // We found a non-quoted value.
            strMatchedValue = arrMatches[ 3 ];

        }


        // Now that we have our value string, let's add
        // it to the data array.
        arrData[ arrData.length - 1 ].push( strMatchedValue );
    }

    // Return the parsed data.
    return( arrData );
}



function readSingleFile(e) {
  var file = e.target.files[0];
  if (!file) {
    return;
  }
  var reader = new FileReader();
  if(e.target.id=='file-input_xml'){
    uploaded_xml_filename = document.getElementById(e.target.id).value;
    reader.onload = function(e) {
      var contents = e.target.result;
      document.getElementById('adressbuch_xml').value = contents;
      //alert('here your csv file');
      convert_to_csv();
    };
  }
  if(e.target.id=='file-input_csv'){
    uploaded_csv_filename = document.getElementById(e.target.id).value;
    reader.onload = function(e) {
      var contents = e.target.result;
      document.getElementById('adressbuch_csv').value = contents;
      //alert('here your xml file');
      convert_to_xml();
    };
  }
  reader.readAsText(file);
}


document.getElementById('file-input_xml')
  .addEventListener('change', readSingleFile, false);
document.getElementById('file-input_csv')
  .addEventListener('change', readSingleFile, false);



//if source manuell changed, remove filename
document.getElementById('adressbuch_xml')
  .addEventListener('change', function reset_filename_xml(){ uploaded_xml_filename = ''; }, false);
document.getElementById('adressbuch_csv')
  .addEventListener('change', function reset_filename_csv(){ uploaded_csv_filename = ''; }, false);

document.getElementById('file-input_xml').value='';
document.getElementById('file-input_csv').value='';

function show_advanced_view(){
 var e = document.getElementsByClassName('advanced_view');
 for(i=0;i<e.length;i++){
  e[i].style.display='inline-block';
 }
 document.getElementById("show_advanced_view_link_wrapper").style.display='none';
}

//-->
</script>
<footer>
<span style="display:block;position:fixed;bottom:2pt;width:100%;left:0pt;padding:2pt;z-index:-1;font-size:10pt;">
<a href="https://github.com/soerenj/fritzbox_phonebook_convert_xml_csv/" style="padding-right:4pt;float:right">fork me</a>
<!--<em style="color:#ababab;float:right;padding-right:10pt; ">file process only name & phone number</em>-->
<details lang="en" class="en"><summary title="more privacy info" style="cursor:pointer;color:#999999">Full Privacy</summary><div style="color:#999999">You Privacy are keept: works just offline (pure javascript). But anyway, bedder check the code or <a href="https://github.com/soerenj/fritzbox_phonebook_convert_xml_csv/commits/master" title="commit/version-history on github">History</a>, in case this account are was hacked.<br>You are still unsure, using this? Open the Browser in Privacy/Incognito-Mode, open this page, go offline and do you file-convertation. And after it close all Privacy/Incognito-Mode-Windows.</div></details>
<details lang="de" class="de" style="display:none"><summary title="more privacy info" style="cursor:pointer;color:#999999">voller Datenschutz</summary><div style="color:#999999">Datenschutz ist gewahrt: arbeitet als offline-Programm (reines javascript). Aber natürlich trotzdem, besser den Programmcode oder <a href="https://github.com/soerenj/fritzbox_phonebook_convert_xml_csv/commits/master">Versions-Verlauf</a> prüfen, für den Fall das dieser Account gehackt wurde.<br>Immernoch unsicher das hier zu nutzen? Den Browser im Privaten/Incognito-Modus öffnen, diese Seite öffnen, offline gehen und die Daten konvertieren. Und dannach alle Privacy/Incognito-Modus-Fenster schließen.</div></details>
</footer>
</span>
<script language="JavaScript">
//replace with german content
var language = window.navigator.userLanguage || window.navigator.language;
if(language.substring(0,2)=='de'){
 var e = document.getElementsByClassName('de');
 for(i=0;i<e.length;i++){
  e[i].style.display='inline-block';
 }
 var e = document.getElementsByClassName('en');
 for(i=0;i<e.length;i++){
  e[i].style.display='none';
 }
}
</script>
